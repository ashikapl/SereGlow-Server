<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Schedule</title>
    <link rel="stylesheet" href="../../static/css/main.css" />
    <link rel="stylesheet" href="../../static/css/schedule.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />
  </head>
  <body>
    <!-- Admin Dashboard (Hidden by default) -->
    <div id="adminDashboard" class="dashboard-container">
      <div class="dashboard-content">
        <nav id="sidebar" class="active">
          <div class="custom-menu">
            <button type="button" id="sidebarCollapse" class="toggleBtn">
              <i class="fa fa-bars"></i>
              <span class="sr-only">Toggle Menu</span>
            </button>
          </div>
          <div class="p-3">
            <h2>
              <a href="/admin" class="logo"
                >Admin Dashboard <span>Welcome, {{admin_name}}!</span>
              </a>
            </h2>
            <ul class="list-unstyled components mb-5">
              <li>
                <a href="/admin/"
                  ><i class="fas fa-chart-bar mr-3"></i> Overview</a
                >
              </li>
              <li>
                <a href="{{ url_for('service_bp.get_services') }}">
                  <i class="fas fa-list mr-3"></i> Manage Services
                </a>
              </li>
              <li>
                <a href="{{ url_for('appointment_bp.show_appointment') }}"
                  ><i class="fas fa-calendar mr-3"></i> Appointments</a
                >
              </li>
              <li>
                <a href="{{ url_for('payment_bp.get_admin_payment') }}"
                  ><i class="fas fa-wallet mr-3"></i> Payments</a
                >
              </li>
              <li class="active">
                <a href="{{ url_for('schedule_bp.show_schedule') }}"
                  ><i class="fas fa-clock mr-3"></i> Shop Schedule</a
                >
              </li>
              <li>
                <a href="{{ url_for('feedback_bp.show_feedback') }}"
                  ><i class="fas fa-comments mr-3"></i> Feedback</a
                >
              </li>
              <li>
                <a href="{{ url_for('admin_bp.show_admin_profile') }}"
                  ><i class="fas fa-user mr-3"></i> Profile</a
                >
              </li>
              <li>
                <a href="{{ url_for('admin_bp.admin_logout') }}"
                  ><i class="fas fa-sign-out mr-3"></i> Logout</a
                >
              </li>
            </ul>
          </div>
        </nav>

        <div class="dashboard-main">
          <!-- Schedule Management -->
          <div id="adminScheduleSection" class="dashboard-section">
            <form id="scheduleForm" class="schedule-form">
              <div class="content-header">
                <h2>Shop Schedule</h2>
                <div class="header-buttons">
                  <button type="submit" class="btn btn-primary">Save</button>
                </div>
              </div>

              <div class="schedule-grid">
                {% for schedule_day in schedule_data %}
                <div
                  class="schedule-day"
                  data-day="{{schedule_day.day_of_week.lower()}}"
                >
                  <div class="day-header">
                    <div class="day-toggle">
                      <label class="toggle-switch">
                        <input
                          type="checkbox"
                          data-day="{{schedule_day.day_of_week.lower()}}"
                          {%
                          if
                          schedule_day.is_open
                          %}checked{%
                          endif
                          %}
                        />
                        <span class="slider"></span>
                      </label>
                      <span class="day-name">{{schedule_day.day_of_week}}</span>
                    </div>
                    <div
                      class="unavailable"
                      {%
                      if
                      schedule_day.is_open
                      %}
                      style="display: none"
                      {%
                      else
                      %}
                      style="display: block"
                      {%
                      endif
                      %}
                      data-day="{{schedule_day.day_of_week.lower()}}"
                    >
                      Not available
                    </div>
                    <span
                      class="day-info"
                      {%
                      if
                      schedule_day.is_open
                      %}
                      style="display: inline"
                      {%
                      else
                      %}
                      style="display: none"
                      {%
                      endif
                      %}
                    ></span>
                  </div>
                  <div
                    class="time-slots-container"
                    {%
                    if
                    schedule_day.is_open
                    %}
                    style="display: flex"
                    {%
                    else
                    %}
                    style="display: none"
                    {%
                    endif
                    %}
                    data-day="{{schedule_day.day_of_week.lower()}}"
                  >
                    {% if schedule_day.slots %} {% for slot in
                    schedule_day.slots %}
                    <div class="time-slot" style="margin-bottom: 25px">
                      <input
                        type="time"
                        id="{{schedule_day.day_of_week.lower()}}Start{{loop.index}}"
                        class="time-input start-time"
                        name="start_time"
                        value="{{ slot.start_time[:5] }}"
                      />
                      <span class="time-separator">to</span>
                      <input
                        type="time"
                        id="{{schedule_day.day_of_week.lower()}}End{{loop.index}}"
                        class="time-input end-time"
                        name="end_time"
                        value="{{ slot.end_time[:5] }}"
                      />

                      {% if not loop.first %}
                      <button type="button" class="delete-btn">
                        <i class="fa fa-trash"></i>
                      </button>
                      {% endif %}
                    </div>
                    {% endfor %} {% else %}
                    <div class="time-slot" style="margin-bottom: 25px">
                      <input
                        type="time"
                        id="{{schedule_day.day_of_week.lower()}}Start{{loop.index}}"
                        class="time-input"
                        name="start_time"
                        value="00:00"
                      />
                      <span class="time-separator">to</span>
                      <input
                        type="time"
                        id="{{schedule_day.day_of_week.lower()}}End{{loop.index}}"
                        class="time-input"
                        name="end_time"
                        value="12:00"
                      />
                    </div>
                    {% endif %}
                  </div>
                  <div
                    class="btn-container"
                    data-day="{{schedule_day.day_of_week.lower()}}"
                    {%
                    if
                    schedule_day.is_open
                    %}
                    style="display: block"
                    {%
                    else
                    %}
                    style="display: none"
                    {%
                    endif
                    %}
                  >
                    <button type="button" class="btn add-slot-btn">
                      + Add Slot
                    </button>
                  </div>
                </div>
                {% endfor %}
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      class ScheduleManager {
        constructor() {
          this.initializeEventListeners();
          this.updateAllSlotCounts();
        }

        initializeEventListeners() {
          // Toggle switches
          document
            .querySelectorAll(".toggle-switch input")
            .forEach((toggle) => {
              toggle.addEventListener("change", (e) =>
                this.handleToggleChange(e)
              );
            });

          // Add slot buttons
          document.querySelectorAll(".add-slot-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => this.addTimeSlot(e));
          });

          // Delete buttons for existing slots
          document.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => this.deleteTimeSlot(e));
          });

          // Real-time form data preview
          document.addEventListener("change", () => this.updateFormPreview());
        }

        handleToggleChange(event) {
          const day = event.target.dataset.day;
          const scheduleDay = event.target.closest(".schedule-day");
          const isChecked = event.target.checked;

          const timeSlots = scheduleDay.querySelector(".time-slots-container");
          const unavailable = scheduleDay.querySelector(".unavailable");
          const btnContainer = scheduleDay.querySelector(".btn-container");
          const dayInfo = scheduleDay.querySelector(".day-info");

          if (isChecked) {
            // Enable day
            timeSlots.style.display = "flex";
            unavailable.style.display = "none";
            btnContainer.style.display = "block";
            dayInfo.style.display = "inline";

            // Add a default slot if none exist
            if (timeSlots.children.length === 0) {
              this.createTimeSlot(day, "09:00", "17:00");
            }
          } else {
            // Disable day
            timeSlots.style.display = "none";
            unavailable.style.display = "block";
            btnContainer.style.display = "none";
            dayInfo.style.display = "none";
          }

          this.updateSlotCount(day);
          this.updateFormPreview();
        }

        addTimeSlot(event) {
          const day = event.target.closest(".schedule-day").dataset.day;
          this.createTimeSlot(day, "09:00", "17:00");
          this.updateSlotCount(day);
          this.updateFormPreview();
        }

        createTimeSlot(day, startTime = "", endTime = "") {
          const scheduleDay = document.querySelector(`[data-day="${day}"]`);
          const timeSlotsContainer = scheduleDay.querySelector(
            ".time-slots-container"
          );

          const timeSlot = document.createElement("div");
          timeSlot.className = "time-slot";
          timeSlot.innerHTML = `
                    <input type="time" class="time-input start-time" value="${startTime}">
                    <span class="time-separator">to</span>
                    <input type="time" class="time-input end-time" value="${endTime}">
                    <button type="button" class="delete-btn">
                        <i class="fa fa-trash"></i>
                    </button>
                `;

          // Add event listener for the delete button
          timeSlot
            .querySelector(".delete-btn")
            .addEventListener("click", (e) => this.deleteTimeSlot(e));

          // Add change listeners for real-time preview
          timeSlot.querySelectorAll(".time-input").forEach((input) => {
            input.addEventListener("change", () => this.updateFormPreview());
          });

          timeSlotsContainer.appendChild(timeSlot);
        }

        deleteTimeSlot(event) {
          const timeSlot = event.target.closest(".time-slot");
          const day = event.target.closest(".schedule-day").dataset.day;

          timeSlot.remove();
          this.updateSlotCount(day);
          this.updateFormPreview();
        }

        updateSlotCount(day) {
          const scheduleDay = document.querySelector(`[data-day="${day}"]`);
          const slots = scheduleDay.querySelectorAll(".time-slot");
          const dayInfo = scheduleDay.querySelector(".day-info");

          const slotCount = slots.length;
          dayInfo.textContent = `${slotCount} slot${
            slotCount !== 1 ? "s" : ""
          }`;
        }

        updateAllSlotCounts() {
          document.querySelectorAll(".schedule-day").forEach((day) => {
            const dayName = day.dataset.day;
            this.updateSlotCount(dayName);
          });
        }

        collectFormData() {
          const scheduleData = [];

          document.querySelectorAll(".schedule-day").forEach((dayElement) => {
            const day = dayElement.dataset.day;
            const checkbox = dayElement.querySelector(".toggle-switch input");
            const isOpen = checkbox.checked;

            const dayData = {
              day: day,
              is_open: isOpen,
              time_slots: [],
            };

            if (isOpen) {
              const timeSlots = dayElement.querySelectorAll(".time-slot");
              timeSlots.forEach((slot) => {
                const startTime = slot.querySelector(".start-time").value;
                const endTime = slot.querySelector(".end-time").value;

                if (startTime && endTime) {
                  dayData.time_slots.push({
                    start_time: startTime,
                    end_time: endTime,
                  });
                }
              });
            }

            scheduleData.push(dayData);
          });

          return scheduleData;
        }

        updateFormPreview() {
          const data = this.collectFormData();
          const preview = document.getElementById("formDataPreview");

          let previewText = "";
          data.forEach((day) => {
            if (day.is_open && day.time_slots.length > 0) {
              previewText += `${day.day}: ${day.time_slots.length} slots\n`;
              day.time_slots.forEach((slot) => {
                previewText += `  ${slot.start_time} - ${slot.end_time}\n`;
              });
            } else {
              previewText += `${day.day}: closed\n`;
            }
          });

          preview.innerHTML = `<pre>${previewText}</pre>`;
        }
      }

      // Initialize the schedule manager when DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        new ScheduleManager();
      });
    </script>
    <script>
      document
        .getElementById("scheduleForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const scheduleData = [];

          document.querySelectorAll(".schedule-day").forEach((dayEl) => {
            const dayName = dayEl.querySelector(".day-name").textContent.trim();
            const isOpen = dayEl.querySelector(".toggle-switch input").checked;

            const slots = [];
            dayEl.querySelectorAll(".time-slot").forEach((slotEl) => {
              const inputs = slotEl.querySelectorAll(".time-input");
              if (inputs.length === 2) {
                slots.push({
                  start_time: inputs[0].value,
                  end_time: inputs[1].value,
                });
              }
            });

            scheduleData.push({
              day_of_week: dayName,
              is_open: isOpen,
              slots: slots,
            });
          });

          console.log("Posting schedule:", scheduleData);

          // Send data to backend
          let allOk = true; // check all res is ok

          for (let i = 0; i < scheduleData.length; i++) {
            console.log("curr day", scheduleData[i]);

            // Base URL from Jinja2
            const baseUrl = "{{ url_for('schedule_bp.add_schedule', id=0) }}";
            // Replace 0 with actual k
            const url = baseUrl.replace("0", i + 1);

            const res = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(scheduleData[i]),
            });

            if (!res.ok) allOk = false;

            const result = await res.text();
            // console.log(
            //   "Response for",
            //   scheduleData[i].day_of_week,
            //   ":",
            //   result
            // );
          }

          // Show the data in a nice format
          if (allOk) {
            alert(
              `Form Data Collected!\n\nTotal Days: ${
                scheduleData.length
              }\nOpen Days: ${
                scheduleData.filter((d) => d.is_open).length
              }\n\nCheck console for full data.`
            );
          } else {
            alert("Error: " + (result.error || "Something went wrong"));
          }
        });
    </script>
    <script>
      document
        .getElementById("sidebarCollapse")
        .addEventListener("click", function () {
          document.getElementById("sidebar").classList.toggle("active");
        });
    </script>
  </body>
</html>
